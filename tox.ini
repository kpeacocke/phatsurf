[tox]
envlist = py313, lint, format, coverage

[testenv]
description = Run tests and generate coverage reports.
deps =
    pytest
    pytest-cov
    pymongo
    flask
    flask-pymongo
    python-dotenv
commands =
    pytest --cov=app --cov-report=xml:coverage.xml --cov-report=html:htmlcov --cov-config=.coveragerc
    # Normalize paths for SonarCloud (adjust for relative paths)
    sed -i 's|/home/runner/work/phatsurf/phatsurf/||g' coverage.xml

[testenv:lint]
description = Run linting tools: isort and flake8.
deps =
    flake8
    flake8-bugbear
    flake8-comprehensions
    isort
commands =
    isort --check-only app tests
    flake8 app tests

[testenv:format]
description = Auto-format code with isort and black.
deps =
    isort
    black
commands =
    isort app tests
    black app tests

[testenv:coverage]
description = Generate and display a coverage report.
deps =
    coverage
    pytest-cov
commands =
    coverage report --fail-under=90
    coverage html
    coverage xml
    # Normalize paths for SonarCloud
    sed -i 's|/home/runner/work/phatsurf/phatsurf/||g' coverage.xml

[flake8]
max-line-length = 88
exclude = .tox, .venv, .git, __pycache__, build, dist
extend-ignore = E203, W503
import-order-style = cryptography
application-import-names = app
# E203 and W503 are ignored to maintain compatibility with Black

[isort]
profile = black
line_length = 88
known_first_party = app
known_third_party = flask,pymongo,pytest
skip_gitignore = true

[coverage:xml]
# Ensure coverage reports use relative paths for SonarCloud compatibility.
output = coverage.xml
relative_files = True